# siegeNgin 設計レビュー R2 — 悪魔の代弁者

**レビュアー**: メフィ（Devil's Advocate）
**対象**: CONCEPT.md（改訂版）+ WHY.md
**日付**: 2026-02-20
**前回**: design-review.md（同日・初回）

---

## 前回6項目の解決状況

### 1. 城門モデルの論理的な穴 → ✅ 大幅改善

**前回の指摘**: ステートレスでも1回の被害が致命的 / 足軽がGeminiにデータ送信する矛盾

**改訂での対応**:
- 足軽を「伝令」に再定義。**外部AIを呼ばない。固定レスポンス。コスト$0**。これで「城外にデータを持ち出す」矛盾が完全に消えた。
- **足軽フィルタポリシー**を新設。城門を通すのは構造情報（タグ名・セレクタ・コメント）のみ、テキスト内容・属性値は通さない。本隊はサーバーローカルの`latest.json`を直接読む。

**評価**: これは根本的な設計改善。攻撃面が劇的に縮小した。「銀行口座の残高が漏れる」問題は、フィルタポリシーで構造情報のみに絞ることで実質的に解消。

### 2. 足軽/本隊の二段構えの隙 → ✅ 解消

**前回の指摘**: 足軽の一次応答が本隊と矛盾するリスク / 足軽がAI応答するなら「既読通知」ではない

**改訂での対応**:
- 足軽は「届けました🏰」の固定レスポンスのみ。判断も実行もしない。
- 本隊がWakeで起きて内容を読み、チャットチャネルで応答。

**評価**: 完璧な解決。足軽からAIを剥がしたことで、矛盾の余地がゼロになった。「二段構え」ではなく「伝令→本隊」の一本道になり、前回指摘した同期問題・矛盾リスク・フォールバック問題がすべて消えた。副産物としてコスト$0も美しい。

### 3. OTP → セッショントークンの弱点 → ⚠️ 部分的

**前回の指摘**: TTLなし / チャネル依存 / ブルートフォースDoS / リプレイ

**改訂での対応**:
- 構造は維持（OTP 5分 → セッショントークン → 明示的失効）
- 変更なし

**未解決**:
- **セッショントークンのTTLは依然として未定義**。「明示的失効まで有効」のまま。漏洩時のリスク窓が無制限。
- OTPリプレイ、ロックDoSも言及なし。

**評価**: フィルタポリシーで城門を通るデータが構造情報のみになったため、トークン漏洩時の**被害の深刻度は大幅に下がった**。とはいえ、TTLは設計原則として入れるべき。「24h自動失効、チャットから延長可」程度の一文で十分。

### 4. チャットチャネルの単一障害点 → ⚠️ 未解決

**前回の指摘**: Telegram障害 = 全機能停止 / 認証操作の認証が未定義

**改訂での対応**: 変更なし。

**評価**: ここは意図的な割り切りだと読める。個人ツールとして「Telegramが死んだらsiegeNginも止まる」は許容範囲かもしれない。ただし**設計文書で明示的にリスク受容すべき**。「チャットチャネルが単一障害点であることを認識した上で、個人利用においてはフォールバック不要と判断」の一文があるだけで、読者の信頼度が変わる。

### 5. 公開ツールとしての懸念 → ⚠️ 部分的

**前回の指摘**: デプロイ要件なし / config.json保護なし / Chrome拡張の権限スコープ未定義

**改訂での対応**:
- config.jsonからトークンを排除（OTP認証に移行）。これで「config.json漏洩 = 即死」は解消。
- デプロイ要件、拡張権限スコープは依然として未記載。

**評価**: config.jsonの問題は実質解消。デプロイ要件はREADMEレベルの話なので、CONCEPT.mdに書く必要はないかもしれない。拡張権限は`activeTab`で十分なはずで、ARCHITECTURE.mdで言及すればよい。

### 6. メタファーに引っ張られた見落とし → ✅ 改善

**前回の指摘**: PRI:130型の話を分離すべき / 「壁を溶かす」と「城壁で守る」の矛盾 / エラーハンドリング等の平凡な問題

**改訂での対応**:
- **WHY.mdに個人的動機を分離**。CONCEPT.mdが公開ツールの設計文書として純化された。
- チャネル分離（入力 vs 制御）を明示。「壁を溶かす」と「城壁で守る」の対象が異なることが読み取れるようになった。
- 「記号接地（Symbol Grounding）」の導入で、指さしの理論的裏付けが強化された。

**評価**: WHY.md分離は正解。CONCEPT.mdの公開ツールとしての普遍性が上がった。記号接地の概念導入も良い。「100%の言語化が10%で済むなら、それは革命」——前回「誇大」と指摘した主張が、適切な粒度に着地した。

---

## 改訂で新たに生まれた穴

### N1. `latest.json` がサイレントな攻撃面

> 本隊はサーバーローカルの `latest.json` を直接読むため、城門を通らない。

城門のフィルタポリシーは「構造情報のみ通す」だが、**`latest.json`にはフィルタ前のフルデータが保存される**はず（本隊が全データを見る必要があるため）。つまり:

- `latest.json` にはテキスト内容・属性値を含むフルデータが存在する
- このファイルへのアクセス権 = 城門を迂回した全データアクセス

サーバーローカルなので外部からの直接アクセスはないが、サーバーが侵害された場合、`latest.json`が最も価値の高い標的になる。ファイルの保持期間・上書きポリシー・パーミッションについて一言あるべき。

### N2. 足軽フィルタの境界ケース

フィルタポリシーは明快だが、境界ケースがある:

- **CSSセレクタに意味のあるclass名が含まれる場合**: `.user-balance`, `.medical-record` など、セレクタ自体が情報を漏らす
- **コメント**: ユーザーが自分で書くため、ここに機密情報を書く可能性は排除できない（が、これはユーザー責任で正しい）

致命的ではないが、フィルタポリシーの「構造情報は安全」という暗黙の前提に小さな穴がある。

### N3. Wakeメカニズムの未定義

> 本隊がWakeで起きて内容を読む

足軽が伝令なら、本隊を起こすトリガーは何か？ Webhook？ ポーリング？ チャットチャネル経由の通知？ 城門を通らないはずの本隊が、どうやって「新しいポイントが来た」と知るのか。ここのメカニズムが設計レベルで抜けている。

---

## 総評

| 領域 | 前回 | 今回 | 変化 |
|------|------|------|------|
| コアコンセプト | ◎ | ◎ | 記号接地で理論補強 |
| アーキテクチャ | ○ | ◎ | 足軽の再定義が秀逸 |
| セキュリティ | △ | ○ | フィルタポリシーで実質的に強化 |
| 公開設計 | △ | ○△ | config.json問題解消、残はREADMEレベル |
| メタファー | ○△ | ○ | WHY.md分離で純化 |

### 判定: **これならいける** 🟢

前回の最大の懸念だった「足軽がGeminiにデータを送る矛盾」と「足軽/本隊の応答矛盾」が、足軽を伝令に再定義することで根本解決された。この改訂は表面的な修正ではなく、**アーキテクチャレベルの再設計**。

残課題:
1. セッショントークンのTTL — 一文追加で済む
2. チャットチャネル単一障害点の明示的リスク受容 — 一文追加で済む
3. `latest.json` の保護方針 — ARCHITECTURE.mdで言及すべき
4. Wakeメカニズム — ARCHITECTURE.mdで定義すべき

いずれも設計を殺す問題ではない。枝葉の補強で対応可能。

足軽からAIを剥がした判断が、この改訂の白眉。コスト$0・攻撃面ゼロ・矛盾ゼロを同時に達成した。叩いた甲斐があった。

— メフィ
